<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>nc3rs_arrive</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-8fd1faf6fd93e4e6d207ae0f9db51d78.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="fullcontent quarto-light">

<div id="quarto-search-results"></div>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block"></header>




<section id="the-2009-nc3rs-systematic-survey" class="level1">
<h1>The 2009 NC3Rs systematic survey</h1>
<div class="notes">
<p>All of this is important in its own right, but to see why it is so important that you understand and are able to apply these concepts, let’s consider the 2009 NC3Rs systematic survey of published experiments using animal subjects.</p>
</div>
<section id="the-importance-of-experimental-design" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="the-importance-of-experimental-design">The importance of experimental design</h2>
<div class="columns">
<div class="column" style="width:60%;">
<blockquote class="blockquote">
<p>“For scientific, ethical and economic reasons, <strong>experiments involving animals should be appropriately designed, correctly analysed and transparently reported</strong>. This increases the scientific validity of the results, and maximises the knowledge gained from each experiment. A minimum amount of relevant information must be included in scientific publications to ensure that the methods and results of a study can be reviewed, analysed and repeated. Omitting essential information can raise scientific and ethical concerns.” (<span class="citation" data-cites="Kilkenny2009-cn">@Kilkenny2009-cn</span>)</p>
</blockquote>
<div class="callout callout-style-default callout-important callout-empty-content callout-titled" title="We rely on the reporting of the experiment to know if it was appropriate">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>We rely on the reporting of the experiment to know if it was appropriate
</div>
</div>
<div class="callout-body-container callout-body">

</div>
</div>
</div><div class="column" style="width:40%;">
<p><img src="assets/images/kilkenny.png" class="img-fluid"></p>
</div>
</div>
<div class="notes">
<p>The National Centre for the Replacement, Refinement, and Reduction of Animals in Research (NC3Rs) was established in 2004 as the UK’s national organisation for the 3Rs (Reduction, Replacement, Refinement). It works with scientists to replace the use of animals by developing new approaches and technologies or, where use of animals is unavoidable, to reduce the number of animals used in each experiment and to minimise any pain, suffering or distress that the animals may experience.</p>
<p>In 2009, the NC3Rs published a systematic survey (Kilkenny et al.&nbsp;(2009)) of the quality of reporting, experimental design, and statistical analysis of recently-published biomedical research using animals.</p>
<p><strong>It did not make for pleasant reading.</strong></p>
</div>
</section>
<section id="causes-for-concern-1" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="causes-for-concern-1">Causes for concern 1</h2>
<div class="columns">
<div class="column" style="width:60%;">
<blockquote class="blockquote">
<p>“Detailed information was collected from 271 publications, about the objective or hypothesis of the study, the number, sex, age and/or weight of animals used, and experimental and statistical methods. <strong>Only 59% of the studies stated the hypothesis</strong> or objective of the study and the number and characteristics of the animals used. […] <strong>Most of the papers surveyed did not use randomisation (87%) or blinding (86%)</strong>, to reduce bias in animal selection and outcome assessment. <strong>Only 70% of the publications that used statistical methods described their methods and presented the results with a measure of error or variability</strong>.” (<span class="citation" data-cites="Kilkenny2009-cn">@Kilkenny2009-cn</span>)</p>
</blockquote>
</div><div class="column" style="width:40%;">
<p><img src="assets/images/kilkenny_blinding.png" class="img-fluid"></p>
</div><div class="callout callout-style-default callout-warning callout-empty-content callout-titled" title="We cannot rely on the literature for good examples of experimental design">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Warning</span>We cannot rely on the literature for good examples of experimental design
</div>
</div>
<div class="callout-body-container callout-body">

</div>
</div>
</div>
<div class="notes">
<p>The state of the published literature around animal experiments was not good in 2009.</p>
<ul>
<li>40% of studies did not state the hypothesis or objective of the experiment</li>
<li>Most papers did not use randomisation or blinding, although this is an essential practice to avoid bias</li>
<li>Only 70% of publications described their statistical methods at all</li>
</ul>
</div>
</section>
<section id="causes-for-concern-2" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="causes-for-concern-2">Causes for concern 2</h2>
<div class="callout callout-style-default callout-important callout-titled" title="No publication explained their choice for the number of animals used">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>No publication explained their choice for the number of animals used
</div>
</div>
<div class="callout-body-container callout-body">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="assets/images/kilkenny_sample_size.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:55.0%"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-empty-content callout-titled" title="We cannot rely on the verbal authority of 'published scientists' or 'experienced scientists' for good experimental design">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Warning</span>We cannot rely on the verbal authority of ‘published scientists’ or ‘experienced scientists’ for good experimental design
</div>
</div>
<div class="callout-body-container callout-body">

</div>
</div>
<div class="notes">
<ul>
<li>One of the most shocking pieces of information is that, of the 48 papers surveyed, <strong>not a single one explained why they used the number of animals that they did</strong>.</li>
<li>We cannot therefore be assured that the number of animals used was chosen to minimise suffering, or to obtain a statistically justifiable result.</li>
<li>These papers are published. They are written, and the experiments conducted, by “experienced scientists”</li>
<li>Being an “experienced” or “published” scientist is clearly not a benchmark for good experimental design</li>
</ul>
<p>Remember, these are “experienced,” “published” scientists in receipt of tens of thousands, maybe hundreds of thousands of pounds worth of funding. If you query their methods, they are likely to claim that having performed these experiments, published the outcomes, and received funding to do so, makes their opinion right and yours wrong. Resist this bullying. Always question how these numbers are decided upon and how the experiment is designed and performed. You are sometimes the experimental subjects’ only voice.</p>
</div>
</section>
<section id="very-strong-cause-for-concern" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="very-strong-cause-for-concern">Very strong cause for concern</h2>
<blockquote class="blockquote">
<p>“<strong>Power analysis or other very simple calculations</strong>, which are widely used in human clinical trials and are often <strong>expected by regulatory authorities</strong> in some animal studies, can help to determine an appropriate number of animals to use in an experiment in order to detect a biologically important effect if there is one. This is a <strong>scientifically robust and efficient</strong> way of determining animal numbers and may ultimately <strong>help to prevent animals being used unnecessarily</strong>. <em>Many of the studies that did report the number of animals used reported the numbers inconsistently between the methods and results sections. The reason for this is unclear, but this does pose a significant problem when analysing, interpreting and repeating the results.</em>” (<span class="citation" data-cites="Kilkenny2009-cn">@Kilkenny2009-cn</span>)</p>
</blockquote>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>As scientists, you - <strong>yourselves</strong> - need to understand the principles behind the statistical tests you use, in order to choose appropriate tests and methods, and to use appropriate measures to minimise animal suffering and obtain meaningful results.</p>
<p><strong>You cannot simply rely on the word of “experienced scientists” for this.</strong></p>
</div>
</div>
<div class="notes">
<ul>
<li>The Kilkenny paper does propose solutions to this problem</li>
<li>They require the use and reporting of straightforward statistical calculations
<ul>
<li><strong>Power calculations</strong>, which, given assumptions appropriate to the experiment, indicate how many experimental subjects are required to determine the result to a desired level of certainty.</li>
<li>We will work through how to make these calculations in the workshop.</li>
</ul></li>
<li>It is up to <strong>you</strong> as scientists to maintain your integrity and that of the experiment, in abiding by good practice and choosing appropriate tests and methods.</li>
</ul>
</div>
</section>
<section id="the-arrive-guidelines" class="level2">
<h2 class="anchored" data-anchor-id="the-arrive-guidelines">The ARRIVE guidelines</h2>
<div class="columns">
<div class="column" style="width:70%;">
<p>The following year <span class="citation" data-cites="Kilkenny2010-cp">@Kilkenny2010-cp</span> proposed the <a href="https://nc3rs.org.uk/our-portfolio/arrive-animal-research-reporting-vivo-experiments">ARRIVE guidelines</a>: a checklist to help researchers report their animal research transparently and reproducibly.</p>
<ul>
<li>Good reporting is essential for peer review and to inform future research</li>
<li>Reporting guidelines measurably improve reporting quality</li>
<li>Improved reporting maximises the output of published research</li>
</ul>
</div><div class="column" style="width:30%;">
<p><img src="assets/images/arrive.png" class="img-fluid"></p>
</div>
</div>
<div class="notes">
<ul>
<li>Kilkenny and colleagues didn’t just highlight the problems and run away.</li>
<li>In 2010 they proposed the ARRIVE guidelines for reporting animal research
<ul>
<li>This takes the form of a checklist that enables good reporting of research, improving manuscript policy and maximising the output of research.</li>
</ul></li>
<li>In order to fulfil the guidelines, basic activities in experimental design - consideration of the use of both sexes, power calculations and so on - must be incorporated early in the research process.</li>
</ul>
</div>
</section>
<section id="arrive-guidelines-highlightes" class="level2">
<h2 class="anchored" data-anchor-id="arrive-guidelines-highlightes">ARRIVE guidelines highlightes</h2>
<p>Many journals now routinely request information in the ARRIVE framework, often as electronic supplementary information. The framework covers 20 items including the following (<span class="citation" data-cites="Kilkenny2010-cp">@Kilkenny2010-cp</span>):</p>
<div class="callout callout-style-default callout-tip callout-titled" title="ARRIVE guidelines (highlights)">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>ARRIVE guidelines (highlights)
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><ol start="4" type="1">
<li><strong>Objectives</strong>: primary and any secondary objectives of the study, or specific hypotheses being tested</li>
</ol></li>
<li><ol start="6" type="1">
<li><strong>Study design</strong>: brief details of the study design, including the number of experimental and control groups, any steps taken to minimise the effects of subjective bias, and the experimental unit</li>
</ol></li>
<li><ol start="10" type="1">
<li><strong>Sample size</strong>: the total number of animals used in each experiment and the number of animals in each experimental group; how the number of animals was decided</li>
</ol></li>
<li><ol start="13" type="1">
<li><strong>Statistical methods</strong>: details of the statistical methods used for each analysis; methods used to assess whether the data met the assumptions of the statistical approach</li>
</ol></li>
<li><ol start="16" type="1">
<li><strong>Outcomes and estimation</strong>: results for each analysis carried out, with a measure of precision (e.g., standard error or confidence interval).</li>
</ol></li>
</ul>
</div>
</div>
<div class="notes">
<ul>
<li>The ARRIVE guidelines have been quite successful</li>
<li>Many journals now request information about the experiment in the ARRIVE framework</li>
<li>Key steps are included that were highlighted as frequently absent in the 2009 study
<ul>
<li>The experiment’s objectives</li>
<li>How the study was designed to minimise noise and systematic biases</li>
<li>How the sample size was calculated and justified</li>
<li>What statistical methods were used for analysis and why they are appropriate</li>
<li>Reporting of outcomes with estimates of variation/precision</li>
</ul></li>
</ul>
</div>
</section>
<section id="a-vital-step" class="level2">
<h2 class="anchored" data-anchor-id="a-vital-step">A vital step</h2>
<div class="columns">
<div class="column" style="width:60%;">
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>“A key step in tackling these issues is to ensure that the next generation of scientists are aware of what makes for good practice in experimental design and animal research, and <strong>that they are not led into poor or inappropriate practices by more senior scientists without a proper grasp of these issues</strong>.”</p>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Recommended reading">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>Recommended reading
</div>
</div>
<div class="callout-body-container callout-body">
<p><span class="citation" data-cites="Bate_Clark_2014">@Bate_Clark_2014</span></p>
</div>
</div>
</div><div class="column" style="width:40%;">
<p><img src="assets/images/bate_and_clark.jpg" class="img-fluid"></p>
</div>
</div>
<div class="notes">
<ul>
<li>The NC3Rs study and ARRIVE guidelines have been a vital step in changing the research culture from accepting the word of “experienced” senior scientists to good, objective scientific practice.
<ul>
<li>But there’s still a long way to go</li>
</ul></li>
<li>I can <strong>strongly</strong> recommend the Bate and Clark book as an excellent starting point for if you want to become competent in experimental design and analysis in this context.</li>
</ul>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/sipbs-compbiol\.github\.io\/MP968-Workshop_Experimental_Design_Slides\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>