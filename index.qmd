---
title: "MP968 Experimental Design Workshop"
author: 
  - name: "Leighton Pritchard"
    affiliation: "University of Strathclyde"
date: "2025-11-24"

format:
  revealjs:
    slide-number: true
    controls: true
    preview-links: true
    footer: "MP968 Experimental Design Workshop"
    logo: "assets/images/sipbs_compbio_800.png"
    theme: [default, ./includes/custom.scss]
    width: 1280
    height: 720
    self-contained: true
    
revealjs-plugins:
  - quiz
  
# Location of BibTeX format reference file; may not need to be changed
bibliography: references.bib
---

```{r setup}
library(dplyr)
library(stringr)
library(tidyr)
library(ggpubr)
library(ggplot2)
library(latex2exp)

# Plot normal curves for of height counts for men and women separately and together
# Example from https://avehtari.github.io/ROS-Examples/CentralLimitTheorem/heightweight.html

heights <- data.frame(height=54:75,
                      female=c(80,107,296,695,1612,2680,4645,8201,9948,11733,
                               10270,9942,6181,3990,2131,1154,245,257,0,
                               0,0,0)*10339/74167,
                      male=c(0,0,0,0,0,0,0,542,668,1221,2175,4213,5535,7980,
                             9566,9578,8867,6716,5019,2745,
                             1464,1263)*9983/67552) %>%
  pivot_longer(c(female, male), names_to="sex", values_to="count")

heights_f <- ggplot(heights %>% filter(sex=="female"), aes(x=height, y=count)) +
  geom_col() + 
  stat_function(fun=function(x) 1e4 * dnorm(x, 63.7, 2.7),
                color="orange", lwd=2) +
  xlim(53, 83) + ylim(0, 1700) +
  labs(title="Heights of female adults (US)") +
  theme_minimal()

heights_m <- ggplot(heights %>% filter(sex=="male"), aes(x=height, y=count)) +
  geom_col() + 
  stat_function(fun=function(x) 1e4 * dnorm(x, 69.1, 2.9),
                color="orange", lwd=2) +  
  xlim(53, 83) + ylim(0, 1700) +
  labs(title="Heights of male adults (US)") +
  theme_minimal()

heights_adults <- ggplot(heights, aes(x=height, y=count)) +
  geom_col() + 
  stat_function(fun=function(x) 2.1e4 * (0.52 * dnorm(x, 63.7, 2.7) +
                                       0.48 * dnorm(x, 69.1, 2.9)),
                color="orange", lwd=2) +
  xlim(53, 83) + ylim(0, 2100) +
  labs(title="Heights of all adults (US)") +
  theme_minimal()

# Example binomial and poisson distributions
# A data frame of values 1:20, with some binomial and poisson distributed values
bin_pois_data <- data.frame(count=0:20) %>%
  mutate(pois1=dpois(count, 1)) %>%
  mutate(pois4=dpois(count, 4)) %>%
  mutate(pois10=dpois(count, 10)) %>%
  mutate(binom0=dbinom(count, 20, 0.05)) %>%
  mutate(binom1=dbinom(count, 20, 0.3)) %>%
  mutate(binom2=dbinom(count, 20, 0.5)) %>%
  mutate(binom3=dbinom(count, 40, 0.5)) %>%
  pivot_longer(cols=-count, names_to="params", values_to="freq")

# Informative labels for legends
poisson_labels <- c("lambda=1", "lambda=4", "lambda=10")
binomial_labels <- c("n=20, p=0.01", "n=20, p=0.3", "n=20, p=0.7", "n=40, p=0.3")

poisson_dist <- ggplot(bin_pois_data %>% filter(str_detect(params, "^pois")), aes(x=count, color=params)) +
  geom_line(aes(y=freq), alpha=0.5) +
  geom_point(aes(y=freq)) +
  xlim(-3,20) +
  ylim(0, 0.4) +
  xlab("counts/rate") +
  labs(title="Poisson distributions") +
  scale_color_discrete(labels=poisson_labels) +
  coord_fixed(ratio=50) +
  theme_minimal()

binomial_dist <- ggplot(bin_pois_data %>% filter(str_detect(params, "^binom")), aes(x=count, color=params)) +
  geom_line(aes(y=freq), alpha=0.5) +
  geom_point(aes(y=freq)) +
  xlim(-3,20) +
  ylim(0, 0.4) +
  xlab("successes") +
  labs(title="Binomial distributions") +
  scale_color_discrete(labels=binomial_labels) +
  coord_fixed(ratio=50) +
  theme_minimal()

# Normal distribution demonstration plots
normal_distplot <- function(mu, sd) {
  # Plot figurative null hypothesis distribution
  ggplot() +
    stat_function(fun = dnorm,
                  args = list(mean = mu, sd = sd),
                  geom = "line") +
    xlim(-4 * sd, 4 * sd) +
    xlab(TeX("true difference, $\\theta$")) +
    ylab("density") +
    theme_minimal()
}

# Shade a normal curve between zstart and zend
shade_normal <- function(mu, sd, zstart, zend, fill="#00998a", alpha=0.5, textoffset=0.01) {
  xmin <- qnorm(zstart, mu, sd)
  xmax <- qnorm(zend, mu, sd)
  
  # Mesh of distribution points
  data = data.frame(x=seq(mu - 4 * sd, mu + 4 * sd, by=0.01)) %>%
    mutate(y=dnorm(x, mu, sd))
  
  # Return ggplot2 shaded area as list of <ggproto> objects
  list(
    geom_area(data=subset(data, x >= xmin & x <= xmax),
              aes(x=x, y=y), fill=fill, color=NA, alpha=0.5),
    annotate("segment", color=fill,
             x=xmin, xend=xmin,
             y=0, yend=dnorm(xmin, mu, sd)),
    annotate("text", color=fill,
            x=xmin, y=-textoffset,
            label=ifelse(zstart == 0, "", paste(100 * zstart, "%", sep=""))),
    annotate("segment", color=fill,
             x=xmax, xend=xmax,
             y=0, yend=dnorm(xmax, mu, sd)),
    annotate("text", color=fill,
             x=xmax, y=-textoffset,
             label=ifelse(zend == 1, "", paste(100 * zend, "%", sep="")))
  )
  
}

# Add a CI bar to a normal curve
ci_normal <- function(mu, sd, ci, alpha=0.4) {
  xmin <- qnorm(0.5 * (1 - ci), mu, sd)
  xmax <- qnorm(1 - 0.5 * (1 - ci), mu, sd)
  
  # Return ggplot2 annotation as list of<ggproto>s
  list(
    annotate("pointrange",
             xmin=xmin, xmax=xmax,
             x=mu, y=dnorm(xmax, mu, sd), alpha=alpha),
    annotate("text",
             x=mu, y=dnorm(xmax, mu, sd)-0.01,
             label=paste(100 * ci, "%CI", sep=""))
  )
}

# Add a dashed line marker at a given x position
add_x_marker <- function(x, y, label, linecolor, textcolor) {
  list(
    annotate("segment", # show the observed difference as a dashed line
      x = x, xend = x,
      y = 0, yend = y,
      colour = linecolor,
      size = 1, linetype = "dashed"
    ),
    annotate("text", x = x, y = y + 0.01, label = label, color = textcolor)
  )
}

# Add shaded normal curve in specific colour with labels
shaded_normal <- function(mu, sd, zstart, zend, fill="orange", color="orange", label="", alpha=0.5, textoffset=0.01, textyoffset=0) {
  list(
    stat_function(fun=dnorm, args=list(mean=mu, sd=sd), geom="line", colour=color),
    shade_normal(mu=mu, sd=sd, zstart=zstart, zend=zend, fill=fill, alpha=alpha, textoffset=textoffset),
    annotate("text", colour=color, x=mu + textyoffset, y=dnorm(mu, mu, sd) + 2 * textoffset, label=label),
    annotate("segment", colour=color, x=mu, xend=mu, y=0, yend=dnorm(mu, mu, sd))
  )
}

```

{{< include 01-design.qmd >}}

{{< include 02-nc3rs_arrive.qmd >}}

{{< include 03-distributions.qmd >}}

{{< include 04-estimates.qmd >}}

{{< include 05-significance.qmd >}}

{{< include 06-standard_errors.qmd >}}



# References

## References